#!/bin/bash

# ============================================================================
# Приклади використання багатоступеневої Docker збірки
# Speech Commands Classification Project
# ============================================================================

echo "════════════════════════════════════════════════════════════════"
echo "📚 Приклади використання Docker Multi-Stage Build"
echo "════════════════════════════════════════════════════════════════"
echo ""

# Функція для показу команди та її пояснення
show_example() {
    local title=$1
    local description=$2
    local command=$3
    
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "📌 $title"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "📝 Опис: $description"
    echo ""
    echo "💻 Команда:"
    echo "   $command"
    echo ""
}

# ============================================================================
# БАЗОВІ ПРИКЛАДИ
# ============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  РОЗДІЛ 1: БАЗОВІ ПРИКЛАДИ                                     ║"
echo "╚════════════════════════════════════════════════════════════════╝"

show_example \
    "1.1. Найпростіший запуск з Docker Compose" \
    "Збудувати та запустити проект однією командою" \
    "docker-compose up -d"

show_example \
    "1.2. Переглянути логи Docker Compose" \
    "Дивитись логи в реальному часі" \
    "docker-compose logs -f"

show_example \
    "1.3. Зупинити Docker Compose" \
    "Зупинити та видалити контейнери" \
    "docker-compose down"

# ============================================================================
# ЗБІРКА ОБРАЗУ
# ============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  РОЗДІЛ 2: ЗБІРКА ОБРАЗУ                                       ║"
echo "╚════════════════════════════════════════════════════════════════╝"

show_example \
    "2.1. Стандартна збірка (з кешуванням)" \
    "Збудувати образ використовуючи Docker layer cache" \
    "docker build -t speech-commands-app ."

show_example \
    "2.2. Збірка без кешу" \
    "Повна перезбірка з нуля (корисно при проблемах)" \
    "docker build --no-cache -t speech-commands-app ."

show_example \
    "2.3. Збірка з детальним виводом" \
    "Показати всі кроки збірки для дебагу" \
    "docker build --progress=plain -t speech-commands-app ."

show_example \
    "2.4. Збірка тільки Builder етапу" \
    "Тестування першого етапу (залежності)" \
    "docker build --target builder -t speech-builder ."

show_example \
    "2.5. Збірка тільки Trainer етапу" \
    "Тестування етапу навчання моделі" \
    "docker build --target trainer -t speech-trainer ."

# ============================================================================
# ЗАПУСК КОНТЕЙНЕРА
# ============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  РОЗДІЛ 3: ЗАПУСК КОНТЕЙНЕРА                                   ║"
echo "╚════════════════════════════════════════════════════════════════╝"

show_example \
    "3.1. Базовий запуск" \
    "Запустити контейнер у фоновому режимі" \
    "docker run -d -p 8000:8000 --name speech-app speech-commands-app"

show_example \
    "3.2. Інтерактивний запуск (для дебагу)" \
    "Запустити з виводом в консоль" \
    "docker run -it --rm -p 8000:8000 speech-commands-app"

show_example \
    "3.3. Запуск з restart policy" \
    "Автоматичний перезапуск при падінні" \
    "docker run -d -p 8000:8000 --restart unless-stopped --name speech-app speech-commands-app"

show_example \
    "3.4. Запуск з обмеженням ресурсів" \
    "Обмежити використання CPU та RAM" \
    "docker run -d -p 8000:8000 --memory='2g' --cpus='2' --name speech-app speech-commands-app"

show_example \
    "3.5. Запуск з volume для моделі" \
    "Використати локальну модель замість вбудованої" \
    "docker run -d -p 8000:8000 -v \$(pwd)/model_state_dict.pt:/app/model_state_dict.pt:ro --name speech-app speech-commands-app"

show_example \
    "3.6. Production запуск (все разом)" \
    "Запуск з усіма production налаштуваннями" \
    "docker run -d -p 8000:8000 --name speech-app --restart unless-stopped --memory='2g' --cpus='2' speech-commands-app"

# ============================================================================
# МОНІТОРИНГ І ЛОГИ
# ============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  РОЗДІЛ 4: МОНІТОРИНГ І ЛОГИ                                   ║"
echo "╚════════════════════════════════════════════════════════════════╝"

show_example \
    "4.1. Переглянути всі логи" \
    "Показати всі логи контейнера" \
    "docker logs speech-app"

show_example \
    "4.2. Логи в реальному часі" \
    "Дивитись логи live (Ctrl+C для виходу)" \
    "docker logs -f speech-app"

show_example \
    "4.3. Останні N рядків логів" \
    "Показати тільки останні 100 рядків" \
    "docker logs --tail 100 speech-app"

show_example \
    "4.4. Статистика використання ресурсів" \
    "Дивитись CPU, RAM, Network в реальному часі" \
    "docker stats speech-app"

show_example \
    "4.5. Список запущених контейнерів" \
    "Показати всі активні контейнери" \
    "docker ps"

show_example \
    "4.6. Детальна інформація про контейнер" \
    "Повна інформація про конфігурацію" \
    "docker inspect speech-app"

# ============================================================================
# ТЕСТУВАННЯ API
# ============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  РОЗДІЛ 5: ТЕСТУВАННЯ API                                      ║"
echo "╚════════════════════════════════════════════════════════════════╝"

show_example \
    "5.1. Health check" \
    "Перевірити чи API працює" \
    "curl http://localhost:8000/health"

show_example \
    "5.2. Health check з форматуванням JSON" \
    "Красивий вивід JSON" \
    "curl -s http://localhost:8000/health | python3 -m json.tool"

show_example \
    "5.3. Інформація про модель" \
    "Отримати деталі про модель та класи" \
    "curl -s http://localhost:8000/info | python3 -m json.tool"

show_example \
    "5.4. Класифікація аудіо файлу" \
    "Відправити WAV файл на класифікацію" \
    "curl -X POST -F 'file=@your_audio.wav' http://localhost:8000/predict"

show_example \
    "5.5. Класифікація з красивим виводом" \
    "Класифікація з форматуванням результату" \
    "curl -s -X POST -F 'file=@your_audio.wav' http://localhost:8000/predict | python3 -m json.tool"

show_example \
    "5.6. Відкрити веб-інтерфейс (macOS)" \
    "Відкрити браузер з UI" \
    "open http://localhost:8000"

# ============================================================================
# УПРАВЛІННЯ КОНТЕЙНЕРАМИ
# ============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  РОЗДІЛ 6: УПРАВЛІННЯ КОНТЕЙНЕРАМИ                             ║"
echo "╚════════════════════════════════════════════════════════════════╝"

show_example \
    "6.1. Зупинити контейнер" \
    "Graceful shutdown контейнера" \
    "docker stop speech-app"

show_example \
    "6.2. Запустити зупинений контейнер" \
    "Перезапустити існуючий контейнер" \
    "docker start speech-app"

show_example \
    "6.3. Перезапустити контейнер" \
    "Швидкий перезапуск" \
    "docker restart speech-app"

show_example \
    "6.4. Видалити зупинений контейнер" \
    "Видалити контейнер (потрібно спершу зупинити)" \
    "docker rm speech-app"

show_example \
    "6.5. Примусово видалити контейнер" \
    "Зупинити і видалити одразу" \
    "docker rm -f speech-app"

show_example \
    "6.6. Повний перезапуск" \
    "Зупинити, видалити і запустити знову" \
    "docker stop speech-app && docker rm speech-app && docker run -d -p 8000:8000 --name speech-app speech-commands-app"

# ============================================================================
# РОБОТА З ОБРАЗАМИ
# ============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  РОЗДІЛ 7: РОБОТА З ОБРАЗАМИ                                   ║"
echo "╚════════════════════════════════════════════════════════════════╝"

show_example \
    "7.1. Список образів" \
    "Показати всі локальні образи" \
    "docker images"

show_example \
    "7.2. Знайти конкретний образ" \
    "Фільтрувати образи за назвою" \
    "docker images | grep speech"

show_example \
    "7.3. Розмір образу" \
    "Показати розмір образу" \
    "docker images speech-commands-app"

show_example \
    "7.4. Історія образу (шари)" \
    "Показати всі шари Docker образу" \
    "docker history speech-commands-app"

show_example \
    "7.5. Детальна інформація про образ" \
    "JSON з повною інформацією" \
    "docker image inspect speech-commands-app"

show_example \
    "7.6. Видалити образ" \
    "Видалити образ (спершу видаліть контейнери)" \
    "docker rmi speech-commands-app"

show_example \
    "7.7. Примусово видалити образ" \
    "Видалити навіть якщо є контейнери" \
    "docker rmi -f speech-commands-app"

# ============================================================================
# ВИКОНАННЯ КОМАНД В КОНТЕЙНЕРІ
# ============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  РОЗДІЛ 8: ВИКОНАННЯ КОМАНД В КОНТЕЙНЕРІ                       ║"
echo "╚════════════════════════════════════════════════════════════════╝"

show_example \
    "8.1. Відкрити Bash shell" \
    "Інтерактивна консоль в контейнері" \
    "docker exec -it speech-app /bin/bash"

show_example \
    "8.2. Відкрити Python REPL" \
    "Інтерактивний Python в контейнері" \
    "docker exec -it speech-app python"

show_example \
    "8.3. Перевірити наявність моделі" \
    "Показати файл моделі та його розмір" \
    "docker exec speech-app ls -lh /app/model_state_dict.pt"

show_example \
    "8.4. Перевірити версію PyTorch" \
    "Виконати Python код в контейнері" \
    "docker exec speech-app python -c 'import torch; print(torch.__version__)'"

show_example \
    "8.5. Список файлів в /app" \
    "Показати всі файли проекту" \
    "docker exec speech-app ls -lh /app"

show_example \
    "8.6. Використання RAM в контейнері" \
    "Показати використання пам'яті" \
    "docker exec speech-app free -h"

# ============================================================================
# КОПІЮВАННЯ ФАЙЛІВ
# ============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  РОЗДІЛ 9: КОПІЮВАННЯ ФАЙЛІВ                                   ║"
echo "╚════════════════════════════════════════════════════════════════╝"

show_example \
    "9.1. Копіювати модель з контейнера" \
    "Витягти навчену модель з контейнера на хост" \
    "docker cp speech-app:/app/model_state_dict.pt ./"

show_example \
    "9.2. Копіювати модель в контейнер" \
    "Закинути локальну модель в контейнер" \
    "docker cp model_state_dict.pt speech-app:/app/"

show_example \
    "9.3. Копіювати всю папку /app" \
    "Витягти весь проект з контейнера" \
    "docker cp speech-app:/app ./app_from_container"

show_example \
    "9.4. Копіювати логи (якщо є)" \
    "Витягти файли логів" \
    "docker cp speech-app:/app/logs ./logs_from_container"

# ============================================================================
# ОЧИЩЕННЯ СИСТЕМИ
# ============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  РОЗДІЛ 10: ОЧИЩЕННЯ СИСТЕМИ                                   ║"
echo "╚════════════════════════════════════════════════════════════════╝"

show_example \
    "10.1. Видалити зупинені контейнери" \
    "Очистити неактивні контейнери" \
    "docker container prune"

show_example \
    "10.2. Видалити невикористані образи" \
    "Очистити образи без тегів" \
    "docker image prune"

show_example \
    "10.3. Видалити невикористані volumes" \
    "Очистити Docker volumes" \
    "docker volume prune"

show_example \
    "10.4. Видалити невикористані networks" \
    "Очистити мережі" \
    "docker network prune"

show_example \
    "10.5. Очистити все (обережно!)" \
    "Видалити всі невикористані ресурси" \
    "docker system prune -a"

show_example \
    "10.6. Показати використання диску" \
    "Статистика використання Docker диску" \
    "docker system df"

# ============================================================================
# ДЕБАГ І TROUBLESHOOTING
# ============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  РОЗДІЛ 11: ДЕБАГ І TROUBLESHOOTING                            ║"
echo "╚════════════════════════════════════════════════════════════════╝"

show_example \
    "11.1. Перевірити чи навчається модель" \
    "Дивитись логи збірки на етапі trainer" \
    "docker build --target trainer -t debug-trainer . 2>&1 | grep -E '(Модель|навчання|Training)'"

show_example \
    "11.2. Запустити trainer етап інтерактивно" \
    "Відкрити shell на етапі навчання" \
    "docker build --target trainer -t debug-trainer . && docker run -it --rm debug-trainer /bin/bash"

show_example \
    "11.3. Перевірити чому контейнер падає" \
    "Логи контейнера що впав" \
    "docker logs speech-app && docker inspect speech-app | grep -A 10 'State'"

show_example \
    "11.4. Знайти помилки в логах" \
    "Фільтрувати тільки помилки" \
    "docker logs speech-app 2>&1 | grep -i error"

show_example \
    "11.5. Перевірити health check" \
    "Детальна інформація про health" \
    "docker inspect speech-app | grep -A 20 Health"

show_example \
    "11.6. Повна перезбірка без кешу" \
    "Якщо щось не працює - повна очистка" \
    "docker stop speech-app; docker rm speech-app; docker rmi speech-commands-app; docker build --no-cache -t speech-commands-app ."

# ============================================================================
# КОМБІНОВАНІ СЦЕНАРІЇ
# ============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  РОЗДІЛ 12: КОМБІНОВАНІ СЦЕНАРІЇ                               ║"
echo "╚════════════════════════════════════════════════════════════════╝"

show_example \
    "12.1. Повний цикл: збірка → запуск → тест" \
    "Автоматизований запуск і перевірка" \
    "docker build -t speech-commands-app . && docker run -d -p 8000:8000 --name speech-app speech-commands-app && sleep 5 && curl http://localhost:8000/health"

show_example \
    "12.2. Перезапуск з оновленим кодом" \
    "Оновити код і перезапустити" \
    "docker stop speech-app && docker rm speech-app && docker build -t speech-commands-app . && docker run -d -p 8000:8000 --name speech-app speech-commands-app"

show_example \
    "12.3. Збереження моделі перед оновленням" \
    "Backup моделі перед перезбіркою" \
    "docker cp speech-app:/app/model_state_dict.pt ./model_backup_\$(date +%Y%m%d_%H%M%S).pt"

show_example \
    "12.4. Monitoring loop" \
    "Постійний моніторинг логів з інтервалом" \
    "watch -n 5 'docker logs --tail 20 speech-app'"

show_example \
    "12.5. Автоматичне тестування кожні 30 сек" \
    "Періодична перевірка health" \
    "watch -n 30 'curl -s http://localhost:8000/health | python3 -m json.tool'"

# ============================================================================
# ПІДСУМОК
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "✅ Всі приклади показано!"
echo "════════════════════════════════════════════════════════════════"
echo ""
echo "💡 Швидкий старт:"
echo "   docker-compose up -d"
echo ""
echo "📖 Детальна документація:"
echo "   - README.md"
echo "   - DOCKER_BUILD_GUIDE.md"
echo "   - QUICK_REFERENCE.txt"
echo ""
echo "🧪 Автоматичний тест:"
echo "   ./test_docker_build.sh"
echo ""
echo "════════════════════════════════════════════════════════════════"
