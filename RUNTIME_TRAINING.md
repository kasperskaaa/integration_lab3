# 🚀 Навчання моделі при запуску контейнера (Runtime Training)

## 📋 Концепція

Замість навчання моделі **під час збірки** Docker образу (що призводить до Segmentation fault), 
модель навчається **при першому запуску контейнера**. Це вирішує проблеми з обмеженням пам'яті 
під час Docker build.

## 🔄 Як це працює

```
┌─────────────────────────────────────────────────────────┐
│  Docker Build (швидко, ~2-3 хв)                        │
│  ✓ Встановлення залежностей                            │
│  ✓ Копіювання коду                                     │
│  ✓ Створення entrypoint скрипта                        │
│  ✗ БЕЗ навчання моделі                                 │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│  Docker Run / Startup                                   │
│  1. Контейнер запускається                             │
│  2. Entrypoint перевіряє наявність моделі              │
│  3. Якщо модель відсутня → навчання (~5-10 хв)        │
│  4. Якщо модель є → запуск API одразу                  │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│  Flask API готовий до роботи                           │
└─────────────────────────────────────────────────────────┘
```

## 🎯 Переваги підходу

✅ **Стабільна збірка** - Docker build завжди успішний (немає Segmentation fault)  
✅ **Гнучкість** - можна передати готову модель через volume  
✅ **Персистентність** - модель зберігається між перезапусками  
✅ **Більше ресурсів** - runtime має більше доступної пам'яті  
✅ **Швидка збірка** - образ збирається за 2-3 хвилини  

## 🚀 Використання

### Варіант 1: Docker Compose (рекомендовано)

```bash
# Збудувати образ (швидко, без навчання)
docker-compose build

# Запустити (модель навчиться при першому запуску)
docker-compose up -d

# Переглянути логи навчання
docker-compose logs -f speech-app

# Очікуйте ~5-10 хвилин на перше навчання
```

### Варіант 2: Docker команди

```bash
# Збудувати образ
docker build -t speech-commands-app .

# Запустити з volume для збереження моделі
docker run -d \
  -p 8000:8000 \
  -v speech-model:/app/model_data \
  --name speech-app \
  speech-commands-app

# Переглянути логи навчання
docker logs -f speech-app
```

### Варіант 3: З готовою моделлю

Якщо у вас вже є навчена модель:

```bash
# Збудувати образ
docker build -t speech-commands-app .

# Запустити з локальною моделлю
docker run -d \
  -p 8000:8000 \
  -v $(pwd)/model_state_dict.pt:/app/model_state_dict.pt:ro \
  --name speech-app \
  speech-commands-app

# API запуститься одразу без навчання
```

## 📊 Часові рамки

| Етап | Час | Опис |
|------|-----|------|
| Docker Build | ~2-3 хв | Встановлення залежностей |
| Перший запуск | ~5-10 хв | Завантаження даних + навчання |
| Наступні запуски | ~5-10 сек | API запускається одразу |

## 🔍 Моніторинг процесу

### Перегляд логів навчання

```bash
# Docker Compose
docker-compose logs -f speech-app

# Docker
docker logs -f speech-app
```

Ви побачите:
```
════════════════════════════════════════════════════════════════
🚀 Ініціалізація Speech Commands API
════════════════════════════════════════════════════════════════

❌ Модель не знайдена!

🎓 Запуск навчання моделі...
⏰ Це займе ~3-10 хвилин залежно від ресурсів
💡 Для швидшої ініціалізації створіть volume з готовою моделлю

════════════════════════════════════════════════════════════════
🎯 SPEECH COMMANDS CLASSIFICATION
...
```

### Перевірка статусу

```bash
# Health check (може повертати помилку поки модель навчається)
curl http://localhost:8000/health

# Після навчання отримаєте:
{
  "status": "healthy",
  "model_loaded": true,
  "device": "cpu"
}
```

## 💾 Збереження моделі

### Використання volumes (рекомендовано)

Docker Compose автоматично створює volume `model-data`:

```yaml
volumes:
  - model-data:/app/model_data
```

Модель зберігається між перезапусками контейнера.

### Копіювання моделі з контейнера

```bash
# Після навчання можна витягти модель
docker cp speech-app:/app/model_state_dict.pt ./

# Використати для наступних запусків
docker run -d \
  -p 8000:8000 \
  -v $(pwd)/model_state_dict.pt:/app/model_state_dict.pt:ro \
  --name speech-app \
  speech-commands-app
```

## ⚙️ Налаштування ресурсів

### Рекомендовані ресурси

Для стабільного навчання при runtime:

```yaml
deploy:
  resources:
    limits:
      cpus: '4'      # Максимум CPU
      memory: 4G     # Максимум RAM
    reservations:
      cpus: '2'      # Мінімум CPU
      memory: 2G     # Мінімум RAM
```

### Для швидшого навчання

```bash
docker run -d \
  -p 8000:8000 \
  --cpus="4" \
  --memory="4g" \
  --name speech-app \
  speech-commands-app
```

## 🐛 Troubleshooting

### Модель не навчається (Segmentation fault)

**Причина**: Недостатньо RAM

**Рішення**:
```bash
# Збільште пам'ять
docker run -d -p 8000:8000 --memory="6g" speech-commands-app

# Або зменшіть кількість класів в speech_commands_train.py
CLASSES = ["yes", "no"]  # Замість ["yes", "no", "up", "down"]
```

### Навчання занадто повільне

**Рішення**:
```bash
# Виділіть більше CPU
docker run -d -p 8000:8000 --cpus="8" speech-commands-app

# Або зменшіть EPOCHS в speech_commands_train.py
EPOCHS = 2  # Замість 3
```

### Модель постійно перенавчується

**Причина**: Модель не зберігається між запусками

**Рішення**:
```bash
# Використайте volume
docker run -d -p 8000:8000 -v speech-model:/app speech-commands-app

# Або через Docker Compose (вже налаштовано)
docker-compose up -d
```

### API не запускається після навчання

**Діагностика**:
```bash
# Перевірте логи
docker logs speech-app

# Перевірте чи модель створена
docker exec speech-app ls -lh /app/model_state_dict.pt

# Перевірте процеси
docker exec speech-app ps aux
```

## 📈 Оптимізація

### Для production

1. **Навчіть модель один раз локально**:
```bash
python speech_commands_train.py
```

2. **Додайте модель в образ при збірці**:
```dockerfile
# В Dockerfile додайте:
COPY model_state_dict.pt /app/
```

3. **Або використайте volume**:
```bash
docker run -d -p 8000:8000 \
  -v $(pwd)/model_state_dict.pt:/app/model_state_dict.pt:ro \
  speech-commands-app
```

### Для розробки

Використайте Docker Compose з volume - модель навчиться один раз і буде збережена.

## 🎉 Підсумок

| Сценарій | Команда | Перший запуск | Наступні запуски |
|----------|---------|---------------|------------------|
| Docker Compose | `docker-compose up -d` | ~5-10 хв | ~5-10 сек |
| Docker + volume | `docker run -v ...` | ~5-10 хв | ~5-10 сек |
| З готовою моделлю | `docker run -v model.pt...` | ~5-10 сек | ~5-10 сек |

**Переваги runtime навчання:**
- ✅ Швидка збірка образу (2-3 хв)
- ✅ Стабільна робота (немає Segmentation fault)
- ✅ Більше доступних ресурсів для навчання
- ✅ Гнучкість використання готових моделей

**Успішного використання! 🚀**
