# ============================================================================
# –ï–¢–ê–ü 1: –ë–∞–∑–æ–≤–∏–π –æ–±—Ä–∞–∑ –∑ —É—Å—ñ–º–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è–º–∏
# ============================================================================
FROM python:3.10-slim AS base

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

WORKDIR /app

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å–∏—Å—Ç–µ–º–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –¥–ª—è –∞—É–¥—ñ–æ –æ–±—Ä–æ–±–∫–∏
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    libsndfile1 \
    && rm -rf /var/lib/apt/lists/*

# –ö–æ–ø—ñ—é—î–º–æ requirements
COPY requirements.txt /app/

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ NumPy 1.x (–¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ PyTorch 2.1.0)
RUN pip install --no-cache-dir "numpy<2"

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ PyTorch CPU-only
RUN pip install --no-cache-dir \
    torch==2.1.0 \
    torchaudio==2.1.0 \
    --index-url https://download.pytorch.org/whl/cpu

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ä–µ—à—Ç—É –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π –≤–∫–ª—é—á–∞—é—á–∏ soundfile
RUN pip install --no-cache-dir -r /app/requirements.txt

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π backend –¥–ª—è torchaudio
ENV TORCHAUDIO_BACKEND=soundfile

# –ö–æ–ø—ñ—é—î–º–æ –≤–µ—Å—å –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç—É
COPY model_utils.py speech_commands_train.py app.py ./
COPY templates ./templates/

# –°—Ç–≤–æ—Ä—é—î–º–æ —Å–∫—Ä–∏–ø—Ç —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —è–∫–∏–π –ø–µ—Ä–µ–≤—ñ—Ä—è—î/–Ω–∞–≤—á–∞—î –º–æ–¥–µ–ª—å –ø—Ä–∏ –ó–ê–ü–£–°–ö–£
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"\n\
echo "ÔøΩ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Speech Commands API"\n\
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"\n\
echo ""\n\
\n\
# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –º–æ–¥–µ–ª—ñ\n\
if [ -f "/app/model_state_dict.pt" ]; then\n\
    echo "‚úÖ –ú–æ–¥–µ–ª—å –∑–Ω–∞–π–¥–µ–Ω–∞: model_state_dict.pt"\n\
    echo "üìè –†–æ–∑–º—ñ—Ä –º–æ–¥–µ–ª—ñ: $(du -h /app/model_state_dict.pt | cut -f1)"\n\
    echo "‚è© –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –Ω–∞–≤—á–∞–Ω–Ω—è"\n\
else\n\
    echo "‚ùå –ú–æ–¥–µ–ª—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞!"\n\
    echo ""\n\
    echo "üéì –ó–∞–ø—É—Å–∫ –Ω–∞–≤—á–∞–Ω–Ω—è –º–æ–¥–µ–ª—ñ..."\n\
    echo "‚è∞ –¶–µ –∑–∞–π–º–µ ~3-10 —Ö–≤–∏–ª–∏–Ω –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä–µ—Å—É—Ä—Å—ñ–≤"\n\
    echo "üí° –î–ª—è —à–≤–∏–¥—à–æ—ó —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å—Ç–≤–æ—Ä—ñ—Ç—å volume –∑ –≥–æ—Ç–æ–≤–æ—é –º–æ–¥–µ–ª–ª—é"\n\
    echo ""\n\
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"\n\
    \n\
    # –ù–∞–≤—á–∞–Ω–Ω—è –º–æ–¥–µ–ª—ñ\n\
    if python speech_commands_train.py; then\n\
        if [ -f "/app/model_state_dict.pt" ]; then\n\
            echo ""\n\
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"\n\
            echo "‚úÖ –ú–æ–¥–µ–ª—å —É—Å–ø—ñ—à–Ω–æ –Ω–∞–≤—á–µ–Ω–∞!"\n\
            echo "üìè –†–æ–∑–º—ñ—Ä –º–æ–¥–µ–ª—ñ: $(du -h /app/model_state_dict.pt | cut -f1)"\n\
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"\n\
        else\n\
            echo "‚ùå –ü–û–ú–ò–õ–ö–ê: –ú–æ–¥–µ–ª—å –Ω–µ –±—É–ª–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞ –ø—ñ—Å–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è"\n\
            exit 1\n\
        fi\n\
    else\n\
        echo "‚ùå –ü–û–ú–ò–õ–ö–ê: –ù–∞–≤—á–∞–Ω–Ω—è –Ω–µ –≤–¥–∞–ª–æ—Å—è"\n\
        exit 1\n\
    fi\n\
fi\n\
\n\
echo ""\n\
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"\n\
echo "üåü –ó–∞–ø—É—Å–∫ Flask API..."\n\
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"\n\
echo ""\n\
\n\
# –ó–∞–ø—É—Å–∫ Flask API\n\
exec python app.py\n\
' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

# –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –ø–æ—Ä—Ç
EXPOSE 8000

# Health check (–∑ –±—ñ–ª—å—à–∏–º start-period –¥–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è)
HEALTHCHECK --interval=30s --timeout=5s --start-period=600s --retries=3 \
  CMD python -c "import urllib.request,sys; \
resp=urllib.request.urlopen('http://127.0.0.1:8000/health'); \
print(resp.read().decode()); sys.exit(0)" || exit 1

# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ entrypoint –¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
ENTRYPOINT ["/app/entrypoint.sh"]
